import React, { useState, useEffect } from "react";
import { IoMdClose, IoMdFunnel } from "react-icons/io";
import axios from 'axios';
import { useLocation } from 'react-router-dom';
import { FaCheck } from "react-icons/fa6";
import { RxCross2 } from "react-icons/rx";

const PricingSection = () => {
  const [selectedPages, setSelectedPages] = useState("1-5 pages");
  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [service, setService] = useState({});
  const location = useLocation();

  useEffect(() => {
    const fetchData = async () => {
      try {
        const slug = location.pathname.split('/').filter(Boolean).pop();
        const response = await axios.get(`http://localhost:3006/api/packages/front/${slug}`, { withCredentials: true });
        console.log("API Response:", response.data);

        // Normalize keys to match pageOptions
        const normalizedService = {};
        Object.keys(response.data.data.subcategories).forEach(key => {
          const normalizedKey = key.trim(); // Trim any extra spaces
          normalizedService[normalizedKey] = response.data.data.subcategories[key];
        });

        setService(normalizedService);
      } catch (error) {
        console.error("Error fetching service data:", error);
      }
    };

    fetchData();
  }, [location.pathname]);

  // Ensure keys are consistent with the API data
  const pageOptions = Object.keys(service);

  const filteredItems = service[selectedPages] || [];
  console.log("Filtered Items:", filteredItems);

  // Helper function to parse JSON strings to arrays
  const parseJsonArray = (jsonArray) => {
    try {
      return JSON.parse(jsonArray);
    } catch {
      return [];
    }
  };

  return (
    <div className="flex flex-col items-center justify-center relative bg-white overflow-hidden">
      {/* Mobile Filter Button */}
      <button
        className="sm:hidden mt-20 mx-0 w-auto flex items-center justify-start px-4 py-2 text-lg font-inter focus:outline-none bg-[#F55F42] text-white rounded-lg"
        onClick={() => setIsFilterOpen(!isFilterOpen)}
        aria-expanded={isFilterOpen}
        aria-label="Toggle filter"
      >
        <IoMdFunnel className="mr-2" />
        Filter
      </button>

      {/* Page Filter Section */}
      <div className="mt-10 sm:mt-20 w-full px-6 sm:w-3/4  ">
        <div className="sm:flex flex-wrap gap-4 mb-6 hidden">
          {pageOptions.map((option) => (
            <button
              key={option}
              onClick={() => setSelectedPages(option)}
              className={`px-4 py-2 text-lg font-inter focus:outline-none ${
                selectedPages === option
                  ? "bg-[#F55F42] text-white rounded-lg"
                  : "text-gray-800 border border-gray-300 rounded-lg"
              }`}
            >
              {option}
            </button>
          ))}
        </div>

        {isFilterOpen && (
          <div className="sm:hidden fixed inset-0 bg-white z-50 p-4">
            <button
              className="absolute top-4 right-4 text-gray-800 text-3xl"
              onClick={() => setIsFilterOpen(false)}
              aria-label="Close filter"
            >
              <IoMdClose />
            </button>
            <div className="flex flex-col space-y-4 mt-10">
              {pageOptions.map((option) => (
                <button
                  key={option}
                  onClick={() => {
                    setSelectedPages(option);
                    setIsFilterOpen(false);
                  }}
                  className={`px-4 py-2 text-lg font-inter focus:outline-none ${
                    selectedPages === option
                      ? "bg-[#F55F42] text-white rounded-lg"
                      : "text-gray-800 border border-gray-300 rounded-lg"
                  }`}
                >
                  {option}
                </button>
              ))}
              <button
                className="px-4 py-2 text-lg font-inter mt-4 bg-[#F55F42] text-white rounded-lg"
                onClick={() => setIsFilterOpen(false)}
              >
                Close
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Pricing Details Section */}
      <div className="mt-10 sm:mt-20 mb-10 w-full px-6 sm:w-3/4">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
          {filteredItems.length > 0 ? (
            filteredItems.map((item) => {
              const whatYouGet = parseJsonArray(item.whatYouGet[0]);
              const whatIsTheir = parseJsonArray(item.whatIsTheir[0]);
              const whatIsNotTheir = parseJsonArray(item.whatIsNotTheir[0]);

              return (
                <div key={item._id} className="bg-white border border-gray-300 rounded-lg p-6 mb-4">
                  <h3 className="text-2xl font-bold mb-2">{item.title}</h3>
                  <p className="text-lg text-gray-600 mb-2">Price: ${item.price}</p>
                  <div className="mb-2">
                    <strong>What You Get:</strong>
                    <ul className="list-disc list-inside">
                      {whatYouGet.length ? (
                        whatYouGet.map((feature, index) => (
                          <li key={index}>{feature}</li>
                        ))
                      ) : (
                        <li>No details available</li>
                      )}
                    </ul>
                  </div>
                  <div className="mb-2">
                    <strong>Details:</strong>
                    <ul className="list-disc list-inside">
                      {whatIsTheir.length ? (
                        whatIsTheir.map((detail, index) => (
                          <li key={index}>{detail}</li>
                        ))
                      ) : (
                        <li>No details available</li>
                      )}
                    </ul>
                  </div>
                  <div className="mb-2">
                    <strong>What Is Not Included:</strong>
                    <ul className="list-disc list-inside">
                      {whatIsNotTheir.length ? (
                        whatIsNotTheir.map((exclusion, index) => (
                          <li key={index}>{exclusion}</li>
                        ))
                      ) : (
                        <li>No exclusions listed</li>
                      )}
                    </ul>
                  </div>
                </div>
              );
            })
          ) : (
            <p className="text-gray-600">No items available for the selected option.</p>
          )}
        </div>
      </div>
    </div>
  );
};

export default PricingSection;
